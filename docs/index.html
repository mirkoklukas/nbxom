---

title: `nbx.om`: Notebook Experiments for OpenMind
keywords: fastai
sidebar: home_sidebar

summary: "This module enables you to quickly convert your jupyter notebook into a bundle of files that can be run on BCS'*OpenMind*. "
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: index.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
    
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Getting-started">Getting started<a class="anchor-link" href="#Getting-started">&#182;</a></h1>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Prerequisites">Prerequisites<a class="anchor-link" href="#Prerequisites">&#182;</a></h2><p><strong>1.</strong> Install the package:</p>
<ul>
<li><code>pip install nbx</code></li>
</ul>
<p><strong>2.</strong> Get a singulartiy that has the package installed. Here's one you can built yourself:</p>
<div class="highlight"><pre><span></span>module load openmind/singularity/3.2.0
<span class="nb">export</span> <span class="nv">SINGULARITY_CACHEDIR</span><span class="o">=</span><span class="s2">&quot;/om2/user/{your_user_name}/.singularity&quot;</span>
singularity build pytorch.simg docker://mklukas/pytorch
</pre></div>
<p><strong>3.</strong> For the modules to work you have to set the environment variables <a href="/om.html"><code>om</code></a>, <code>omx</code>, and <code>omsimg</code>:</p>
<ul>
<li><strong>om</strong>: your login to <em>OpenMind</em>. <ul>
<li>You need to enable logging into <em>OpenMind</em> using public key authentication. That means the command <code>ssh $om</code> should log you in whithout asking for a password. (googling for "ssh public key authentication" will provide you with a recipe like <a href="https://kb.iu.edu/d/aews">this</a>)</li>
</ul>
</li>
<li><strong>omx</strong>: path to the folder where <em>nbx</em> bundles are stored. This path will automatically be added to your python path. Any modules that are not part of your bundles <code>src/</code> folder or are included in your singularity container should go here.</li>
<li><strong>omsimg</strong>: path to the folder containing your singularity images</li>
</ul>
<p>Mac users can adapt and copy the following lines to their <code>.bash_profile</code></p>
<div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">om</span><span class="o">={</span>your_user_name<span class="o">}</span>@openmind7.mit.edu
<span class="nb">export</span> <span class="nv">omx</span><span class="o">=</span>/om2/user/<span class="o">{</span>your_user_name<span class="o">}</span>/nbx-experiments
<span class="nb">export</span> <span class="nv">omsimg</span><span class="o">=</span>/om2/user/<span class="o">{</span>your_user_name<span class="o">}</span>/simg
</pre></div>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Usage">Usage<a class="anchor-link" href="#Usage">&#182;</a></h2><ul>
<li>Put your python scripts that you wrote for this experiment in a folder called <code>src</code>. The folder will be copied to the bundle so the scripts are available on <em>OpenMind</em> as well.</li>
<li><strong>#nbx</strong>: Each cell that contains a <code>#nbx</code> tag in its <strong>first</strong> line will be considered part of the experiment.</li>
<li><strong>#xarg</strong>: Putting <code>#xarg</code> above a variable declaration makes this variable <em>explicit</em>, it will become an argument of the experiment function. Any iterable to the right of the variable declaration, <strong>separated by a semicolon</strong>, will be considered the domain that will be swept during the parameter sweep.</li>
<li>Each nbx-experiment has to declare the variables <code>task_id</code> and <code>results_dir</code>. The <em>task id</em> will be set by the <em>wrapper</em> script and enumerates the configurations of the parameter space. The latter variable will also be set by the <em>wrapper</em> script, it will be replaced by the folder automatically created for a specific parameter configuration. </li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Example">Example<a class="anchor-link" href="#Example">&#182;</a></h1>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%</span><span class="k">matplotlib</span> inline
<span class="o">%</span><span class="k">load_ext</span> autoreload
<span class="o">%</span><span class="k">autoreload</span> 2
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>The autoreload extension is already loaded. To reload it, use:
  %reload_ext autoreload
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#nbx</span>
<span class="c1">#xarg</span>
<span class="n">task_id</span> <span class="o">=</span> <span class="mi">0</span>
<span class="c1">#xarg</span>
<span class="n">results_dir</span> <span class="o">=</span> <span class="s2">&quot;./&quot;</span>

<span class="c1">#xarg</span>
<span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>

<span class="c1">#xarg</span>
<span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">]</span>

<span class="n">z</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#nbx</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;my results:&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>my results: 0 0 0
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">nbx.om</span> <span class="k">import</span> <span class="n">NbxBundle</span>

<span class="n">bundle</span> <span class="o">=</span> <span class="n">NbxBundle</span><span class="p">(</span><span class="n">nbname</span><span class="o">=</span><span class="s2">&quot;index.ipynb&quot;</span><span class="p">,</span> 
          <span class="n">name</span><span class="o">=</span><span class="s2">&quot;test&quot;</span><span class="p">,</span> 
          <span class="n">linting</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
          <span class="n">time</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> 
          <span class="n">ntasks</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> 
          <span class="n">step</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> 
          <span class="n">simg</span><span class="o">=</span><span class="s2">&quot;mirko-datascience.simg&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>[(&#39;task_id&#39;, &#39;0&#39;, &#39;&#39;), (&#39;results_dir&#39;, &#39;&#34;./&#34;&#39;, &#39;&#39;), (&#39;x&#39;, &#39;0&#39;, &#39;&#39;), (&#39;y&#39;, &#39;0&#39;, &#39;[0,1,2,3,4]&#39;)]
/Users/mirko/Workspace/nbx/nbx/templates/experiment.tpl
/Users/mirko/Workspace/nbx/nbx/templates/wrapper.tpl
/Users/mirko/Workspace/nbx/nbx/templates/run.tpl

** nbx bundle created **
Path:
    test_nbx

Source nb:
    index.ipynb

Parameters (#configs 5):
    * y = [0,1,2,3,4]
      task_id = 0
      results_dir = &#34;./&#34;
      x = 0

Instructions:
    Copy to remote, run the bash script, and pull the results
    - `scp -r test_nbx $om:$omx`
    - `ssh $om sbatch -D $omx/test_nbx $omx/test_nbx/run.sh`
    - `scp -r $om:$omx/test_nbx/results ./results`

</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span>python test_nbx/experiment.py
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>**nbx**
Running Experiment...
	kwargs: {}
	y: 0
	x: 0
	results_dir: ./
	task_id: 0
my results: 0 0 0

**nbx**
Experiment finished.
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span>scp -r test_nbx <span class="nv">$om</span>:<span class="nv">$omx</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>wrapper.py                                    100%  950   106.0KB/s   00:00    
__init__.py                                   100%    0     0.0KB/s   00:00    
run.sh                                        100%  732   117.9KB/s   00:00    
experiment.py                                 100%  739    78.9KB/s   00:00    
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span>ssh <span class="nv">$om</span> sbatch -D <span class="nv">$omx</span>/test_nbx <span class="nv">$omx</span>/test_nbx/run.sh
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Submitted batch job 15969897
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">!</span>ssh <span class="nv">$om</span> squeue -u <span class="nv">$omid</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>             JOBID PARTITION     NAME     USER ST       TIME  NODES NODELIST(REASON)
</pre>
</div>
</div>

</div>
</div>

</div>
</div>
 

